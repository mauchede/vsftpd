#!/bin/bash
set -e
cd "`dirname "$0"`/../src"

IMAGE=${IMAGE:-alpine}
TAG=${TAG:-3.1}

LINUX_PAM_VERSION=${LINUX_PAM_VERSION:-1.1.8-r2}

docker run -i --rm -e UID=$(id -u) -e GID=$(id -g) -e LINUX_PAM_VERSION=$LINUX_PAM_VERSION -v $PWD:/dist $IMAGE:$TAG sh <<"EOF"
    set -x \
    && apk add -U gcc git libc-dev make linux-pam-dev=$LINUX_PAM_VERSION \
    && git clone https://github.com/tiwe-de/libpam-pwdfile /tmp/libpam-pwdfile \
    && cd /tmp/libpam-pwdfile \
    && make \
    && make install \
    && cp /lib/security/pam_pwdfile.so /dist/pam_pwdfile.so \
    && chown $UID:$GID /dist/pam_pwdfile.so
EOF
